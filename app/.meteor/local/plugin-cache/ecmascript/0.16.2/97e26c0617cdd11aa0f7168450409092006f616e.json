{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Users\\zianz\\OneDrive\\Documents\\GitHub\\X\\app\\packages\\montiapm:agent\\lib\\wait_time_builder.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.windows.x86_64"},"sourceFileName":"packages/montiapm:agent/lib/wait_time_builder.js","filename":"C:\\Users\\zianz\\OneDrive\\Documents\\GitHub\\X\\app\\packages\\montiapm:agent\\lib\\wait_time_builder.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"C:\\Users\\zianz\\OneDrive\\Documents\\GitHub\\X\\app","root":"C:\\Users\\zianz\\OneDrive\\Documents\\GitHub\\X\\app","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"C:\\Users\\zianz\\OneDrive\\Documents\\GitHub\\X\\app\\packages\\montiapm:agent\\lib\\wait_time_builder.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/montiapm:agent/lib/wait_time_builder.js"}},"code":"module.export({\n  WaitTimeBuilder: () => WaitTimeBuilder\n});\n\nlet _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 0);\nconst WAITON_MESSAGE_FIELDS = ['msg', 'id', 'method', 'name', 'waitTime']; // This is way how we can build waitTime and it's breakdown\n\nclass WaitTimeBuilder {\n  constructor() {\n    this._waitListStore = {};\n    this._currentProcessingMessages = {};\n    this._messageCache = {};\n  }\n\n  register(session, msgId) {\n    const mainKey = this._getMessageKey(session.id, msgId);\n\n    let inQueue = session.inQueue || [];\n\n    if (typeof inQueue.toArray === 'function') {\n      // latest version of Meteor uses a double-ended-queue for the inQueue\n      // info: https://www.npmjs.com/package/double-ended-queue\n      inQueue = inQueue.toArray();\n    }\n\n    const waitList = inQueue.map(msg => {\n      const key = this._getMessageKey(session.id, msg.id);\n\n      return this._getCacheMessage(key, msg);\n    }) || []; // add currently processing ddp message if exists\n\n    const currentlyProcessingMessage = this._currentProcessingMessages[session.id];\n\n    if (currentlyProcessingMessage) {\n      const key = this._getMessageKey(session.id, currentlyProcessingMessage.id);\n\n      waitList.unshift(this._getCacheMessage(key, currentlyProcessingMessage));\n    }\n\n    this._waitListStore[mainKey] = waitList;\n  }\n\n  build(session, msgId) {\n    const mainKey = this._getMessageKey(session.id, msgId);\n\n    const waitList = this._waitListStore[mainKey] || [];\n    delete this._waitListStore[mainKey];\n    const filteredWaitList = waitList.map(this._cleanCacheMessage.bind(this));\n    return filteredWaitList;\n  }\n\n  _getMessageKey(sessionId, msgId) {\n    return \"\".concat(sessionId, \"::\").concat(msgId);\n  }\n\n  _getCacheMessage(key, msg) {\n    let cachedMessage = this._messageCache[key];\n\n    if (!cachedMessage) {\n      this._messageCache[key] = cachedMessage = _.pick(msg, WAITON_MESSAGE_FIELDS);\n      cachedMessage._key = key;\n      cachedMessage._registered = 1;\n    } else {\n      cachedMessage._registered++;\n    }\n\n    return cachedMessage;\n  }\n\n  _cleanCacheMessage(msg) {\n    msg._registered--;\n\n    if (msg._registered == 0) {\n      delete this._messageCache[msg._key];\n    } // need to send a clean set of objects\n    // otherwise register can go with this\n\n\n    return _.pick(msg, WAITON_MESSAGE_FIELDS);\n  }\n\n  trackWaitTime(session, msg, unblock) {\n    const started = Date.now();\n    this._currentProcessingMessages[session.id] = msg;\n    let unblocked = false;\n    const self = this;\n\n    const wrappedUnblock = function () {\n      if (!unblocked) {\n        const waitTime = Date.now() - started;\n\n        const key = self._getMessageKey(session.id, msg.id);\n\n        const cachedMessage = self._messageCache[key];\n\n        if (cachedMessage) {\n          cachedMessage.waitTime = waitTime;\n        }\n\n        delete self._currentProcessingMessages[session.id];\n        unblocked = true;\n        unblock();\n      }\n    };\n\n    return wrappedUnblock;\n  }\n\n}","map":{"version":3,"sources":["packages/montiapm:agent/lib/wait_time_builder.js"],"names":["module","export","WaitTimeBuilder","_","link","v","WAITON_MESSAGE_FIELDS","constructor","_waitListStore","_currentProcessingMessages","_messageCache","register","session","msgId","mainKey","_getMessageKey","id","inQueue","toArray","waitList","map","msg","key","_getCacheMessage","currentlyProcessingMessage","unshift","build","filteredWaitList","_cleanCacheMessage","bind","sessionId","cachedMessage","pick","_key","_registered","trackWaitTime","unblock","started","Date","now","unblocked","self","wrappedUnblock","waitTime"],"mappings":"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","sourcesContent":["import { _ } from 'meteor/underscore';\n\nconst WAITON_MESSAGE_FIELDS = ['msg', 'id', 'method', 'name', 'waitTime'];\n\n// This is way how we can build waitTime and it's breakdown\nexport class WaitTimeBuilder {\n  constructor() {\n    this._waitListStore = {};\n    this._currentProcessingMessages = {};\n    this._messageCache = {};\n  }\n\n  register(session, msgId) {\n    const mainKey = this._getMessageKey(session.id, msgId);\n\n    let inQueue = session.inQueue || [];\n    if (typeof inQueue.toArray === 'function') {\n      // latest version of Meteor uses a double-ended-queue for the inQueue\n      // info: https://www.npmjs.com/package/double-ended-queue\n      inQueue = inQueue.toArray();\n    }\n\n    const waitList =\n      inQueue.map(msg => {\n        const key = this._getMessageKey(session.id, msg.id);\n\n        return this._getCacheMessage(key, msg);\n      }) || [];\n\n    // add currently processing ddp message if exists\n    const currentlyProcessingMessage =\n      this._currentProcessingMessages[session.id];\n    if (currentlyProcessingMessage) {\n      const key = this._getMessageKey(\n        session.id,\n        currentlyProcessingMessage.id\n      );\n      waitList.unshift(this._getCacheMessage(key, currentlyProcessingMessage));\n    }\n\n    this._waitListStore[mainKey] = waitList;\n  }\n\n  build(session, msgId) {\n    const mainKey = this._getMessageKey(session.id, msgId);\n    const waitList = this._waitListStore[mainKey] || [];\n    delete this._waitListStore[mainKey];\n\n    const filteredWaitList = waitList.map(this._cleanCacheMessage.bind(this));\n\n    return filteredWaitList;\n  }\n\n  _getMessageKey(sessionId, msgId) {\n    return `${sessionId}::${msgId}`;\n  }\n\n  _getCacheMessage(key, msg) {\n    let cachedMessage = this._messageCache[key];\n    if (!cachedMessage) {\n      this._messageCache[key] = cachedMessage = _.pick(\n        msg,\n        WAITON_MESSAGE_FIELDS\n      );\n      cachedMessage._key = key;\n      cachedMessage._registered = 1;\n    } else {\n      cachedMessage._registered++;\n    }\n\n    return cachedMessage;\n  }\n\n  _cleanCacheMessage(msg) {\n    msg._registered--;\n    if (msg._registered == 0) {\n      delete this._messageCache[msg._key];\n    }\n\n    // need to send a clean set of objects\n    // otherwise register can go with this\n    return _.pick(msg, WAITON_MESSAGE_FIELDS);\n  }\n\n  trackWaitTime(session, msg, unblock) {\n    const started = Date.now();\n    this._currentProcessingMessages[session.id] = msg;\n\n    let unblocked = false;\n    const self = this;\n\n    const wrappedUnblock = function() {\n      if (!unblocked) {\n        const waitTime = Date.now() - started;\n        const key = self._getMessageKey(session.id, msg.id);\n        const cachedMessage = self._messageCache[key];\n        if (cachedMessage) {\n          cachedMessage.waitTime = waitTime;\n        }\n        delete self._currentProcessingMessages[session.id];\n        unblocked = true;\n        unblock();\n      }\n    };\n\n    return wrappedUnblock;\n  }\n}\n"]},"sourceType":"module","externalDependencies":{},"hash":"97e26c0617cdd11aa0f7168450409092006f616e"}
